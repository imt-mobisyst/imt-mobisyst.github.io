<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Move To - Lct. Mobile-Robot</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../style.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Move To";
        var mkdocs_page_input_path = "tuto-mastering/transform.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> Lct. Mobile-Robot
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="" href="../../..">MobiSyst <</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Intro</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Kick-off</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../tuto-kick-off/basics/">OS and Shell</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../tuto-kick-off/first-contact/">Nodes and Topics</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../tuto-kick-off/package/">ROS Package</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../tuto-kick-off/move/">Move the Robot</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../tuto-kick-off/simulation/">Simulation</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Level-up</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../tuto-level-up/range-sensor/">Range Sensor</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../tuto-level-up/reactive/">Reactive Move</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../tuto-level-up/parameters/">Parameters</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../tuto-level-up/camera-driver/">Camera Driver</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../tuto-level-up/vision/">Vision</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Mastering</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../slam/">S.L.A.M</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../vision/">Image processing</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">Move To</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Challenge</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../challenge/kick-off/">Kick-off</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../challenge/challenge-1on2/">Challenge 1</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../challenge/challenge-2on2/">Challenge 2</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Appendix</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../appendix/installation/">Installation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../appendix/faq/">F.A.Q</a>
                  </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../pdf/"></a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">Lct. Mobile-Robot</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Mastering</li>
      <li class="breadcrumb-item active">Move To</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="move-to">Move To</h1>
<p>The idea here is to develop a move strategy to permits a robot to reach positions successively, in a cluttered environment.
To do that, the node subscribes to a topic <code>goals</code> to get in a position to reach.</p>
<!--
This tutorial supposes that you perform the tutorial "[Move the Robot](1.2-move.md)".
A correction is proposed on [tbot package](https://bitbucket.org/imt-mobisyst/mb6-tbot/src/master/tbot_pytools/tbot_pytools/reactive_move.py).
-->

<p>The main difficulty here, consists in following positioning kwoledge of the goals while the robot is moving.</p>
<h2 id="record-a-goal-position">Record a goal position</h2>
<p>It supposes that you play with at least 2 frames.
A local frame is attached to the robot and is moving with it.
A global frame permits to localize the goal at a fixed position in the environement and the robot (i.e. the local frame).
It supposes that your global frame is fixed in the environment.</p>
<p><img alt="" src="../../files/frames.svg" /></p>
<p>Classically, we use the map frame for global referring system, but without map it is possible to use the <code>odom</code> (from robot odometer).
The robot is defined with different frame: <code>base_link</code> at the gravity center of the robot. <code>base_footprint</code> as a projection of <code>base_link</code> on the floor.</p>
<h3 id="understand-frame-and-transformations">Understand frame and transformations</h3>
<p>By starting any sensor as the laser, the publishing data is in its own frame.
It would be impossible for <em>rviz2</em> to display the laser information into <code>map</code> frame (<em>fixed frame</em>).
The <code>map</code> and <code>laser</code> frames are independent.</p>
<!--Start the laser and rviz2:


<pre><code class="language-console"># First console
ros2 run urg_node urg_node_driver --ros-args -p serial_port:=/dev/ttyACM0
# Second console
rviz2
</code></pre>

-->

<p>In rviz, connect to scan topic, normaly nothing appears.
Try by modifying the global frame with the frame of the laser.</p>
<h3 id="transform-tools">Transform tools</h3>
<p>The package <code>tf2_tools</code> provides with a process that generates a graph of the connection between the frames.</p>
<pre><code class="language-console">#third console
ros2 run tf2_tools view_frames.py
evince frames.pdf
</code></pre>
<p>In <em>ROS</em> <code>tf</code> stand for transformation.
It is a central tool permitting getting space-temporal information from a frame to another.
It supposes that specific messages are published into dedicated topic <code>tf</code>.
At this step, no transform are published...</p>
<p>It is possible to generate a static transformation (it supposes that the laser is fixed in the environment at a specific position)</p>
<pre><code class="language-console">ros2 run tf2_ros static_transform_publisher 0 0 0 0 0 0 1 &quot;map&quot; &quot;laser&quot;
</code></pre>
<p>You can validate with <code>view_frame</code> that the 2 frames ares connected and that laser scan are displayed in <em>rviz</em>.</p>
<p>The first 3 numbers fix the translation.
It is the potion of the <code>laser</code> center into <code>map</code>. The next 4 numbers give the rotation.</p>
<p>In fact, the publisher generates a <a href="https://docs.ros.org/en/jade/api/geometry_msgs/html/msg/TransformStamped.html">TransfromStamped mesage</a> and the rotation is based on quaternion definition (cf. <a href="https://en.wikipedia.org/wiki/Quaternions_and_spatial_rotation">wikipedia</a> for details...)
Display the frames in <em>rviz2</em> (add &gt; axes &gt; set reference frame) and play with different configurations (kill and restart the <code>static_transform_publisher</code>).</p>
<h3 id="tbot-configuration">tbot configuration</h3>
<p>For a simple robot, it can be dozens of frames and it grows with robot parts (legs, arms).
<em>ROS</em> provide a tool (state publisher) to publish transform regarding how the frames are interconnected.
The tbot launch file of the <code>tbot_start</code> package already started state publisher based on a description of the tbot (kobuki robot in IMT Nord Europe configuration, already on <em>pibot</em>).
Connect the robot (via the <code>ROS_DOMAIN_ID</code>) and Generate the frame graph (<code>view_frame</code>).</p>
<p>In basic configuration, the robot provides a first pose estimation in global <code>odom</code> frame (ie. transformation between <code>odom</code> and <code>base_link</code>).
So set the fixed frame in rviz on <code>odom</code>, the laser scans appear.
Connect to tf topic and all the frame axis appear too.</p>
<ul>
<li>Oficial documentation about tf2: <a href="https://docs.ros.org/en/iron/Tutorials/Intermediate/Tf2/Tf2-Main.html">docs.ros.org</a>.</li>
</ul>
<p>Bonus: it is possible to visualize the robot in <em>rviz2</em>: add &gt; robot description (select the appropriate topic).</p>
<h3 id="transform-a-pose-in-a-specific-frame">Transform a pose in a specific frame.</h3>
<p>Naturally, <em>ROS</em> also provide C++ and Python library to manipulate transformation and permits developers to get pose coordinate from a frame to another.</p>
<p>The idea is to a declare a tf2 listener, an object that will subscribe to transform topics and maintain transformation data.
Then it is possible to recompute pose coordinates in any connected frames.</p>
<p>More on : <a href="http://wiki.ros.org/tf2/Tutorials/Writing%20a%20tf2%20listener%20%28Python%29">wiki.ros.org</a>.</p>
<p>The idea in our context is to develop a node <code>localGoal</code> that will remember a pose in a global frame and publish at a given frequence the pose in another local frame.</p>
<p>For our new node, we have to declare the elements permitting the node to listen and keep the transformation available, a <code>listerner</code> and a <code>buffer</code>.</p>
<pre><code class="language-python"># Transform tool (suppose that ros2 is initialized):
tf_buffer = tf2_ros.Buffer()
tf_listener = tf2_ros.TransformListener( tf_buffer )
...
</code></pre>
<p>Do not forget to import <code>tf2_ros</code> into your script and to add the reference into the package dependencies (<code>package.xml</code>).</p>
<!--
The node is also defined with it onw attrituts: for instance a target local frame, a goal pose (position orientation).


<pre><code class="language-python">...
# Node Attribute:
self.local_frame= 'base_link'
self.global_goal= Pose()
self.global_goal.position.x= (float)(1)
self.global_goal.position.y= (float)(2)
...
</code></pre>


And finally we require a timer with a callback function to publish continuously the goal pose.


<pre><code class="language-python">...
node.create_timer( 0.1, self.publish_goal )
...
</code></pre>

-->

<p>We can now address the interesting question: <em>How to transform a position defined into a frame in another frame ?</em>
It consists in building a Transform object from the reference and target frames.
While a listener was declared on a transform buffer, it is possible to create this object from that tool (if exist).</p>
<p>The Transform object is generated with the method <code>lookup_transform(target_frame, reference_frame, time)</code>.
This method gets a <code>target_frame</code> (the frame id in which we want the pose) a <code>reference_frame</code> (the frame id in which the pose is currently defined) and a time.
In fact, the transformations are dynamically.
The position and orientation of elements (the robot(s), robot parts, ...)  change continuously and it is possible to get transformation in the present or in the past.
To get the current transformation a <code>node.time.Time()</code> permits to get the current time.</p>
<p>The lookup is not guaranteed to achieve.
It can fail in case of a gap in the transforms or obsolete transforms.
In case of fail, an exception is thrown accordingly the python exception manager (more on <a href="https://www.w3schools.com/python/python_try_except.asp">w3schools</a>).</p>
<p>Finally, inside our <code>publish_goal</code> call back, getting a transform will look like:</p>
<pre><code class="language-python">    def publish_goal(self):
        currentTime= rclpy.time.Time()
        # Get Transformation (import poses referenced in odom into base_link)
        try:
            stampedTransform= self.tf_buffer.lookup_transform(
                        'base_link',
                        'odom',
                        currentTime)
        except (tf2_ros.LookupException, tf2_ros.ConnectivityException, tf2_ros.ExtrapolationException):TransformException as tex:
            self._node.get_logger().info( f&quot;Could not transform poses from 'odom' into 'base_link': {tex}&quot;)
            return
        ...
</code></pre>
<p>The transform is a stamped transform (ie. defined in a given time) defined by <code>geometry_msgs</code> package.
The pose transformation is already defined in a ros method of <code>tf2_geometry_msgs</code> package and it require the installation of <code>python3-tf2-geometry-msgs</code>(things are never simple in ros...):</p>
<pre><code class="language-console">sudo apt update
sudo apt install python3-tf2-geometry-msgs
</code></pre>
<pre><code class="language-python">    def publish_goal(self):
        ...
        # Compute goal into local coordinates
        myGoalPoseInBaseLink = tf2_geometry_msgs.do_transform_pose(
            myGoalPoseInOdom,
            stampedTransform
        )
        ...
</code></pre>
<h2 id="permit-autonomous-navigation">Permit Autonomous Navigation</h2>
<p>The goal poses itself is not interesting.
The objective now is to include this code into the reactive move node in order to permits the robot to reach a decided destination, by avoiding obstacles.</p>
<ol>
<li>Get the goal pose from a topic pose (a pose can be published with rviz).</li>
<li>Convert the received goal pose into a global frame (<code>odom</code>).</li>
<li>Control the robot to reach the goal (the control is in the local frame)</li>
<li>Stop the robot if it is close enough to the position.</li>
</ol>
<h2 id="going-further-path-following">Going Further - Path following</h2>
<p>Rather than a unique pose, it could be interesting to define a succession of pose to follow (a path).
That for the reactive move has to manage a list of pose and switch from a pose to the next one each time it is expected.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../vision/" class="btn btn-neutral float-left" title="Image processing"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../../challenge/kick-off/" class="btn btn-neutral float-right" title="Kick-off">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../vision/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../../challenge/kick-off/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="../../javascripts/mathjax.js"></script>
      <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
