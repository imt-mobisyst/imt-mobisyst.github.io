<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Range Sensor - Lct. Mobile-Robot</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../style.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Range Sensor";
        var mkdocs_page_input_path = "tuto-level-up/range-sensor.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> Lct. Mobile-Robot
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="" href="../../..">MobiSyst <</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Intro</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Kick-off</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../tuto-kick-off/basics/">OS and Shell</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../tuto-kick-off/first-contact/">Nodes and Topics</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../tuto-kick-off/package/">ROS Package</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../tuto-kick-off/move/">Move the Robot</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../tuto-kick-off/simulation/">Simulation</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Level-up</span></p>
              <ul class="current">
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">Range Sensor</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../reactive/">Reactive Move</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../parameters/">Parameters</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../camera-driver/">Camera Driver</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../vision/">Vision</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Mastering</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../tuto-mastering/slam/">S.L.A.M</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../tuto-mastering/vision/">Image processing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../tuto-mastering/interfaces/">Interfaces</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../tuto-mastering/transform/">Move To</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Challenge</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../challenge/kick-off/">Kick-off</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../challenge/challenge-1on2/">Challenge 1</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../challenge/challenge-2on2/">Challenge 2</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Appendix</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../appendix/installation/">Installation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../appendix/faq/">F.A.Q</a>
                  </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../pdf/"></a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">Lct. Mobile-Robot</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Level-up</li>
      <li class="breadcrumb-item active">Range Sensor</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="range-sensor">Range sensor</h1>
<p><em>Range sensors</em> are robot sensor permitting to detect obstacles and determine a distance to it.
Basic range sensors (infrared, ultrasonic, laser) produce a unique measure considering a given direction at a time.
By making the sensor rotating, it is possible to get measurements on a plan around the sensor.</p>
<p>Hokuhyo, equipping the <strong>Tbot</strong>, is typically a kind of rotating lidar sensor (<strong>l</strong>aser <strong>i</strong>maging or <strong>li</strong>ght <strong>d</strong>etection <strong>a</strong>nd <strong>r</strong>anging).
The goal here is to integrate an almost 360 obstacle detection to generate safe robot movement.</p>
<p>More complex lidar permits 3D measurements (i.e. in several plans at a time).</p>
<h2 id="read-scan-data">Read Scan Data</h2>
<p>The <em>pibots</em> already run <code>urg_node_driver</code> ros node.
This node publish laser scan into a <code>\scan</code> topic.
It is possible to check it with <code>ros2 topic list</code> and <code>ros2 topic echo scan</code>.</p>
<p>Gazebo simulator also simulate laser scan, but the scan topic and/or the laser-scan frame can have different names.</p>
<pre><code>ros2 launch tbot_sim challenge-1.launch.py
</code></pre>
<p>Now you can visualize it on <em>rviz2</em> program.
Start <em>rviz2</em>, <em>add</em> a flux <em>laserScan</em> and configure it in <code>/scan</code> topic.
Nothing appears and it is normal.
<em>Rviz2</em> global option is configured on <em>map</em> frame, and nothing permits to set the position of the laser sensor in the map.
The laser-scan frame is named <em>laser</em>.
Change this information into global options and set the laser-scan size to <code>0,1</code> for a better display.</p>
<!--## Get Scan Data

Well, letâ€™s visualize the laser scan in _rviz2_.
For that, verify that the user has the right to read data on the device.
By connecting the laser sensor, a access file appears in Linux `/dev` directory named `ttyACM0`.
Verify the owner of the file:


<pre><code class="language-console">ls -l /dev | egrep ttyACM
</code></pre>


Normally `/dev/ttyACM0` is owned by user `root` and group `dialout` with `crw-rw----` right, mining that owner and all members of the group can read (`r`) and write (`w`) and all the other users have no access to the resource.
Verify that `bot` is a member of the group `dialout`


<pre><code class="language-console">cat /etc/group | egrep dialout 
</code></pre>


Cool.
Let run a driver to convert device I/O to ros messages.
ROS driver for hokuyo laser range is embedded in the urg_node package 


<pre><code class="language-console">ros2 run urg_node urg_node_driver --ros-args -p serial_port:=/dev/ttyACM0
</code></pre>


Specifying the `serial_port` file requires to activate arguments with `--ros-args` and pass a file path using `-p` parameter command line flag. 
All of this is specific to [ROS parameters](https://docs.ros.org/en/iron/Concepts/Basic/About-Parameters.html).

From that point data are streamed in `/scan` topic.

Stop everything.

Perform the same exercise to visualize simulated LaserScan from Gazebo simulator:


<pre><code>ros2 launch tbot_sim challenge-1.launch.py
</code></pre>


Warning: the scan topic and/or the laser-scan frame can have different names.
-->

<h2 id="a-first-node-logging-the-scan">A first node logging the scan</h2>
<p>First, we will initialize a node <code>scan_echo</code> to print the scan data into a terminal.</p>
<p>Edit a new script file <code>scan_echo</code> en configure your package to recognize it as a ROS2 node.</p>
<p>Test your <code>scan_echo</code> node:</p>
<pre><code class="language-python">ros2 run tutorial_pkg scan_echo
</code></pre>
<ul>
<li>Connect <a href="https://docs.ros2.org/iron/api/sensor_msgs/msg/LaserScan.html">sensor_msgs LaserScan</a>.</li>
<li>Log continuously the received data</li>
</ul>
<pre><code class="language-python">#!python3
import rclpy
from rclpy.node import Node
from sensor_msgs.msg import LaserScan

rosNode= None

def scan_callback(scanMsg):
    global rosNode
    rosNode.get_logger().info( f&quot;scan:\n{scanMsg}&quot; )

rclpy.init()
rosNode= Node('scan_interpreter')
rosNode.create_subscription( LaserScan, 'scan', scan_callback, 10)

rclpy.spin( rosNode )

scanInterpret.destroy_node()
rclpy.shutdown()
</code></pre>
<p>Test your <code>scan_echo</code> node, with the <em>pibot</em> and on simulations.</p>
<p>You can notice that <code>ros_logger</code> print information into <code>info</code> channel (informative), but other channel exits for errors and warnings.</p>
<p>At this point your echo node print the entire <code>scan</code> message, but we do not care about the distance measurements, we want only some meta-data.
Modify the logger to print the information into the <code>header</code> and the number of ranges.</p>
<h2 id="from-laserscan-to-pointcloud">From LaserScan to PointCloud</h2>
<p><strong>LaserScan</strong> provides both the recorded bean distances (ranges) and the meta information permitting converting the distances on points in a regular Cartesian frame (i.e. the angle between beans).</p>
<p>In a python, the conversion would look like this:</p>
<pre><code class="language-python">obstacles= []
angle= scanMsg.angle_min
for aDistance in scanMsg.ranges :
    if 0.1 &lt; aDistance and aDistance &lt; 5.0 :
        aPoint= [
            math.cos(angle) * aDistance,
            math.sin(angle) * aDistance
        ]
        obstacles.append(aPoint)
    angle+= scanMsg.angle_increment
</code></pre>
<p>The exercise consists in modifying the scan callback function to generate the point cloud list.
To log a sample of the point cloud:</p>
<pre><code class="language-python">sample= [ [ round(p[0], 2), round(p[1], 2) ] for p in  obstacles[10:20] ]
self.get_logger().info( f&quot; obs({len(obstacles)}) ...{sample}...&quot; )
</code></pre>
<p>Finally, it is possible to publish this result in a <code>PointCloud</code> message and to visualize it on <em>rviz2</em> in a superposition of the LaserScan. </p>
<p><em>PointCloud</em> is based on <code>geometry_msgs.Point32</code> with float coordinate.
The creation of <em>Point32</em> will require explicite cast.</p>
<pre><code class="language-python">aPoint= Point32()
aPoint.x= (float)(math.cos(angle) * aDistance)
aPoint.y= (float)(math.sin( angle ) * aDistance)
aPoint.z= (float)(0)
</code></pre>
<ul>
<li><em>PointCloud</em> mesage as part of the <a href="https://index.ros.org/p/sensor_msgs">sensor_msgs pkg</a> (yes we are using the deprecated one, and we should not)</li>
</ul>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../../tuto-kick-off/simulation/" class="btn btn-neutral float-left" title="Simulation"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../reactive/" class="btn btn-neutral float-right" title="Reactive Move">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../../tuto-kick-off/simulation/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../reactive/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="../../javascripts/mathjax.js"></script>
      <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
