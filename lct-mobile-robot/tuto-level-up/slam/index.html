<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>S.L.A.M - Lct Mob-Rob</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
        <link href="../../style.css" rel="stylesheet">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">Lct Mob-Rob</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../../.." class="nav-link">MobiSyst <</a>
                            </li>
                            <li class="navitem">
                                <a href="../.." class="nav-link">Home</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Kick-Off <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../tuto-kick-off/ros-basics/" class="dropdown-item">Starting with ROS</a>
</li>
                                    
<li>
    <a href="../../tuto-kick-off/move/" class="dropdown-item">Move the Robot</a>
</li>
                                    
<li>
    <a href="../../tuto-kick-off/simulation/" class="dropdown-item">Simulation</a>
</li>
                                    
<li>
    <a href="../package/" class="dropdown-item">ROS Package</a>
</li>
                                    
<li>
    <a href="../../tuto-kick-off/range-sensor/" class="dropdown-item">Range Sensor</a>
</li>
                                    
<li>
    <a href="../../tuto-kick-off/camera-driver/" class="dropdown-item">Camera Driver</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Level-up <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../class/" class="dropdown-item">Node with Class</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active">S.L.A.M</a>
</li>
                                    
<li>
    <a href="../transform/" class="dropdown-item">Move To</a>
</li>
                                    
<li>
    <a href="../vision/" class="dropdown-item">Vision</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Challenge <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../challenge/kick-off/" class="dropdown-item">Kick-off</a>
</li>
                                    
<li>
    <a href="../../challenge/challenge-1on2/" class="dropdown-item">Challenge 1</a>
</li>
                                    
<li>
    <a href="../../challenge/challenge-2on2/" class="dropdown-item">Challenge 2</a>
</li>
                                </ul>
                            </li>
                            <li class="navitem">
                                <a href="../../appendix/faq/" class="nav-link">F.A.Q</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../class/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../transform/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#what-is-slam-in-a-nutshell" class="nav-link">What is SLAM in a Nutshell?</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#map-building-using-slam_toolbox" class="nav-link">Map building using slam_toolbox</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#launch-slam_toolbox" class="nav-link">Launch slam_toolbox</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#manual-mapping" class="nav-link">Manual Mapping</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#autonomous-navigation-sending-goal-points" class="nav-link">Autonomous Navigation sending goal points</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#save-the-map" class="nav-link">Save the Map</a>
              <ul class="nav flex-column">
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="what-is-slam-in-a-nutshell">What is SLAM in a Nutshell?</h1>
<p>Mobile robots rely heavily on accurate representations of the environment (i.e <em>maps</em>) to fulfill their tasks (autonomous navigation, exploration, ...). Inside buildings, GPS signals are too weak to be used to localize robots. Hence we face a so-called Chicken-and-Egg-Problem, as <em>localization</em> requires a map, and map building (i.e. <em>mapping</em>) requires the current location.
One solution consists in doing <em>Simultaneous Localization and Mapping</em> (a.k.a. SLAM) using a SLAM algorithm that typically reaches centimetric precision.</p>
<p>There are many different flavors of SLAM especially regarding the map format. The dominating 2D map format is the occupancy grid, also called grid map. A grid map is a matrix whose cells represents a defined region of the real world; this is the <em>resolution</em> of the grid map (typically a square of 5cm). A cell holds the estimated probability that the space it represents is traversable (free space) or not (obstacle). The simplest format is the 3-state occupancy grid in which a cell has 3 different possible values: 0 (free space), 0.5 (unknown) and 1 (obstacle).</p>
<p><img alt="Overview of a SLAM algorithm that produces a 3-state occupancy grid map and the robot pose (i.e. the robot position and its orientation)" src="../../files/SLAM/SLAMGridMaps.jpg" /></p>
<!-- Localization
- Dead Reckoning
- Particle Filters
- Kalman Filters
- Pose Graph Optimization
- Scan matching -->

<p><a href="https://navigation.ros.org/setup_guides/transformation/setup_transforms.html">Transformations doc</a></p>
<h1 id="map-building-using-slam_toolbox">Map building using <code>slam_toolbox</code></h1>
<p>There are a lot of different SLAM algorithms and some implementations are open source and available on <a href="https://openslam-org.github.io/">OpenSLAM</a>.</p>
<p>We will use here the <a href="https://github.com/SteveMacenski/slam_toolbox"><code>slam_toolbox</code></a> ROS implementation (documentation is <a href="https://navigation.ros.org/tutorials/docs/navigation2_with_slam.html">here</a>).</p>
<h2 id="launch-slam_toolbox">Launch <code>slam_toolbox</code></h2>
<pre><code class="language-console">ros2 launch tbot_sim challenge-1.launch
</code></pre>
<pre><code class="language-console">ros2 launch slam_toolbox online_sync_launch.py use_sim_time:=False
</code></pre>
<pre><code class="language-console">rviz2
</code></pre>
<blockquote>
<p>Question: using all the tools you already know (<code>rviz2</code>, <code>rqt_graph</code>, tf, ...), what are the input and output data of <code>slam_toolbox</code>?</p>
</blockquote>
<h2 id="manual-mapping">Manual Mapping</h2>
<p>Launch a teleop:</p>
<pre><code class="language-console"># keyboard
ros2 run teleop_twist_keyboard teleop_twist_keyboard

# or xbox
ros2 launch teleop_twist_joy teleop-launch.py joy_config:=xbox
</code></pre>
<p>Now, while moving the robot around the simulated environment, you should see the result of <code>slam_toolbox</code> (both the map and robot pose) updated in <code>rviz2</code>.</p>
<!-- ![GMapping demo rqt_graph](../files/SLAM/gmapping_stage_rqt_graph.png) -->

<p><img alt="tf tree" src="../../files/SLAM/frames_slam.png" /></p>
<h1 id="autonomous-navigation-sending-goal-points">Autonomous Navigation sending goal points</h1>
<blockquote>
<p>Facultative part</p>
</blockquote>
<pre><code>ros2 launch nav2_bringup navigation_launch.py
</code></pre>
<p>Be carreful, navigation should publish in the right topic so that the robot receive command velocities.
Then, send goal points into <code>/goal_pose</code> (use rviz2)</p>
<h1 id="save-the-map">Save the Map</h1>
<pre><code class="language-console">ros2 run nav2_map_server map_saver_cli -f /home/bot/map
</code></pre>
<blockquote>
<p>Sometimes this command produces a timeout. This is because it listens to the <code>map</code> topic no map is received during a certain amount of time and we cannot extend this delay...</p>
</blockquote>
<p>Another solution to save the map is to use the following service call:</p>
<pre><code class="language-console">ros2 service call /slam_toolbox/save_map slam_toolbox/srv/SaveMap &quot;name: {data: '/home/bot/map2'}&quot;
</code></pre>
<!-- # All in one

Stop everything.


<pre><code>ros2 launch nav2_bringup slam_launch.py
</code></pre>


Then, map can be saved using:


<pre><code>
``` --&gt;

# Load a map and Localize in it

To load a map and localize in it, you should:

1. execute:

</code></pre>

ros2 launch nav2_bringup localization_launch.py map:=/home/bot/map.yaml autostart:=True

<pre><code>
2. publish an approximate initial pose into the topic `/initialpose` (using rviz2 for example)

3. move the robot around (teleop or so) to improve the acuracy of the localization

# Load a map and Localize in it __in simulation__

Same steps as above but the time is simulated:

</code></pre>

ros2 launch nav2_bringup localization_launch.py map:=/home/bot/map.yaml autostart:=True use_sim_time:=True

rviz2 --ros-args --remap use_sim_time:=True
```

# Bag files (`ros2 bag`)

Working in simulation is nice but we can do better and work directly on real data using the `ros2 bag` command tool.
The idea is to record some topics (all data that goes through) into a [bag file](http://wiki.ros.org/Bags) and play them later on.
Bag files are really useful to test algorithms on real data sets that have been recorded in a specific location and with  specific sensors.
Moreover, there are a lot of public datasets available:

- [http://radish.sourceforge.net/]
- [https://vision.in.tum.de/data/datasets/rgbd-dataset/download]
- [http://www.ipb.uni-bonn.de/datasets/]
- [http://car.imt-lille-douai.fr/polyslam/]


Use the [tutorial on rosbag](https://docs.ros.org/en/iron/Tutorials/Beginner-CLI-Tools/Recording-And-Playing-Back-Data/Recording-And-Playing-Back-Data.html) to learn how to use it.

> Work: Launch the challenge 2 simulation, record `/tf` and `/scan` into a rosbag and teleop the robot all around the map. You now have a dataset ready to do offline SLAM.

# Offline Mapping

> Work: Play the rosbag created before and launch `slam_toolbox` in offline mode to create the map and then save it. You can now load this map to localize the robot into it.

# Map a real arena

Re-do exactly the same things to map an existing arena:

1. Put the robot inside the arena
2. Record a bag file with all needed data to achieve SLAM
3. Manually teleoperate the robot everywhere in the arena
4. Save the bag file
5. Play the bag file and launch the SLAM to create a map and save it (offline mapping)
6. Put the robot inside the arena and load the map to localize the robot inside the arena

>Hint: `slam_toolbox` comes with a RViz plugin (Panels->Add New Panel->slam_toolbox->SlamToolboxPlugin) that might help

# Tuning map quality

SLAM algorithms usually have a lot of parameters that can be tuned to improve performance or map quality.
`slam_toolbox` is no exception. Some hints [here](https://www.robotandchisel.com/2020/08/19/slam-in-ros2/).

<!-- Comparing resulting maps and localization:
- cite Sang's paper
- Python package for the evaluation of odometry and SLAM
https://michaelgrupp.github.io/evo/ --></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../js/jquery-3.6.0.min.js"></script>
        <script src="../../js/bootstrap.min.js"></script>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js"></script>
        <script src="../../javascripts/mathjax.js"></script>
        <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
        <script src="../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
